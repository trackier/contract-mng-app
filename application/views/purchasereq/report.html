<div class="content">
    <div class="container-fluid">
		<div class="row">
			<div class="col-sm-12">
				<div class="row">
					<div class="col-sm-12">
						
						{echo Shared\Markup::message($message ?? null)}
					</div>
				</div>
				
				
			</div>
		</div>
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Search </h6>
            </div>
            <form class="card-body" method="get">
                <div class="form-row">
                    <div class="form-group col-sm-2">PR Id</div>
                    <div class="form-group col-sm-2">Status</div>
                    <div class="form-group col-sm-2">Type</div>
                    <div class="form-group col-sm-2">Vendor</div>
                    <div class="form-group col-sm-2">Approver</div>
                    <div class="form-group col-sm-2">Requester</div>
                    <div class="form-group col-sm-2">Department</div>
                </div>
                <div class="form-row">
                    <div class="form-group col-sm-2">
                        <input type="text" name="query[name]" class="form-control" value="{echo $query['name']}" placeholder = "Search asset name">
                    </div>
                    <div class="form-group col-sm-2">
                        <select class="form-control" name="query[status]" value="{echo $query['status'] ?? ''}">
                            <option value="">All</option>
                            <option value="pending">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="rejected by department">Rejected by department</option>
                            <option value="processed">Processed</option>
                        </select>
                    </div>
                    <div class="form-group col-sm-2">
                        <select class="form-control" name="query[requester]" value="{echo $query['status'] ?? ''}">
                            <option value="">All</option>
                            <option value="pending">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="rejected by department">Rejected by department</option>
                            <option value="processed">Processed</option>
                        </select>
                    </div>
                    <div class="form-group col-sm-2">
                        <select class="form-control" name="query[approver]" value="{echo $query['status'] ?? ''}">
                            <option value="">All</option>
                            <option value="pending">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="rejected by department">Rejected by department</option>
                            <option value="processed">Processed</option>
                        </select>
                    </div>
                    <div class="form-group col-sm-2">
                        <select class="form-control" name="query[asset_type]" value="{echo $query['asset_type']}">
                            <option value="">All</option>
                            <option value="car">Car</option>
                            <option value="laptop">Laptop</option>
                            <option value="phone">Phone</option>
                            <option value="ipad">Ipad</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group col-sm-2">
                        <select class="form-control" name="query[ven_id]" value="{echo $query['ven_id']}">
                            <option value="">All</option>
                            {foreach $v in $vendors}
                            <option value="{echo $v->_id}">({echo $v->name}) {echo $v->company_name}</option>
                            {/foreach}
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <button type="submit" class="btn btn-outline-primary">
                        <i class="fa fa-search"></i> Submit
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <form class="card-body" method="get">
            <div class="form-row">
                <div class="form-group col-2"> Select Status</div>
                <div class="form-group col-2">
                    <select  onchange="this.form.submit()" class="form-control" name="query[status]" value="{echo $query['status'] ?? ''}">
                        <option value="">All</option>
                        <option value="pending">Awaiting Approval</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="rejected by department">Rejected by department</option>
                        <option value="processed">Processed</option>
                    </select>
                </div>
            </div>
            
        </form>

        <div>
            {if $purchasereq }
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered display" id="" style="width:100%" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Requester</th>
                                    <th>PR Id</th>
                                    <th>Expected Date</th>
                                    <th>Status</th>
                                    <th>Approver</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                
                                </tr>
                            </thead>
                            <tbody>
                                {foreach $obj in $purchasereq}
                                    <tr data-id='{echo $obj->_id}'>
                                        {script $user = User::first(["_id" => $obj->requester_id], [], ['maxTimeMS' => 5000 ])}
                                        {script $user2 = User::first(["_id" => $obj->approver1_id], [], ['maxTimeMS' => 5000 ])}
                                        <td>{echo $user->name}<br>
                                            Submitted On: {echo Framework\TimeZone::printDate($obj->submittedOn)}
                                        </td>
                                        <td>$obj->pr_id</td>
                                        <td>{echo Framework\TimeZone::printDate($obj->expectedDate)}</td>
                                        <td>{echo $obj->status}</td>
                                        <td>{echo $user2->name}</td>
                                        <td>₹ $obj->amount</td>
                                        {if ($query['status'] == 'pending')}
                                            <td>
                                                <a href="/purchasereq/approve1/{echo $obj->_id}" class="btn btn-xs btn-outline-success delete"><i class="fa fa-tick"></i> Approve</a> 
                                                <a  data-toggle="modal" data-target="#rejectReason"  data-id='{echo $obj->id}' class="btn btn-xs btn-outline-danger delete open-denyrequest"><i class="fa fa"></i> Deny</a>
                                                <a class="btn btn-outline-primary"  href="/purchasereq/view/{echo $obj->_id}" padding="10px"><i class="fa fa-pencil-square-o" style="margin-right:5px"></i>View</a>
                                            </td>
                                        {/if}
                                        {if ($query['status'] == 'approved' || $query['status'] == 'rejected by department' || $query['status'] == '')}
                                        <td>
                                            <a class="btn btn-outline-primary"  href="/purchasereq/view/{echo $obj->_id}" padding="10px"><i class="fa fa-pencil-square-o" style="margin-right:5px"></i>View</a>
                                        </td>
                                        {/if}
                                        
                                        
                                    </tr>
                                {/foreach}
                            
                            </tbody>
                            
                        </table>
                    </div>
                </div>
            </div>
            {/if} {else}
            <div class="card-body">
                <p class="card-text">No requests found</p>
            </div>
            {/else}
        </div>
	</div>
</div>

{include purchasereq/filter/purchasereq.html}

<div class="modal fade" id="rejectReason" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
aria-hidden="true">
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title" id="exampleModalLabel">Please mention the request denial reason</h5>
			<button class="close" type="button" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">×</span>
			</button>
		</div>
        <form class="form-horizontal m-t-20" id="formId" method="post" enctype="multipart/form-data" >
            <div class="modal-body"><textarea name="data[denialReason]" style="width:100%"></textarea> </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="id">Remove</button>
            </div>
        </form>
		
	</div>
</div>


</div>
<script type="text/javascript">

$(document).ready(function () {
    $('table.display').DataTable();
});
    $('.open-denyrequest').on('click', function () {
        console.log($(this).data('id'))
         var objId = $(this).data('id');
         
        $("#formId").attr('action', '/purchasereq/deny1/'+objId);
      //  $("#id").attr('href','/purchasereq/manage');
    })
    </script>
